<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Restablecer contraseña</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f9f9f9; padding: 40px; }
        .container { background: #fff; padding: 32px; border-radius: 8px; box-shadow: 0 2px 8px #ccc; max-width: 400px; margin: auto; }
        .msg { margin-top: 24px; font-size: 1.1em; }
        .success { color: #388e3c; }
        .error { color: #d32f2f; }
        .login-link, .guardar-btn { display: inline-block; margin-top: 24px; background: #1976d2; color: #fff; padding: 10px 24px; border-radius: 6px; text-decoration: none; font-weight: bold; border: none; cursor: pointer; }
        .form-group { margin-bottom: 16px; }
        label { display: block; margin-bottom: 6px; font-weight: bold; }
        input[type="password"] { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Restablecer contraseña</h2>
        <div class="msg" id="mensaje"></div>
        <form id="formReset" style="display:block;">
            <div class="form-group">
                <label for="nuevaPassword">Nueva contraseña</label>
                <input type="password" id="nuevaPassword" name="nuevaPassword" required minlength="6" maxlength="16">
            </div>
            <div class="form-group">
                <label for="repetirPassword">Repetir contraseña</label>
                <input type="password" id="repetirPassword" name="repetirPassword" required minlength="6" maxlength="16">
            </div>
            <button type="submit" class="guardar-btn">Guardar</button>
        </form>
        <div id="loginEnlace" style="display:none;">
            <a href="/login.html" class="login-link">Ir al login</a>
        </div>
    </div>
    <script>
        function getTokenFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('token');
        }

        function mostrarResultado(mensaje, exito) {
            const msgDiv = document.getElementById('mensaje');
            msgDiv.innerText = mensaje;
            msgDiv.className = exito ? 'msg success' : 'msg error';
            if (exito) {
                document.getElementById('formReset').style.display = 'none';
                document.getElementById('loginEnlace').style.display = 'block';
            }
        }

        document.getElementById('formReset').onsubmit = function(e) {
            e.preventDefault();
            const nuevaPassword = document.getElementById('nuevaPassword').value;
            const repetirPassword = document.getElementById('repetirPassword').value;
            if (nuevaPassword !== repetirPassword) {
                mostrarResultado("Las contraseñas no coinciden.", false);
                return;
            }
            const token = getTokenFromUrl();
            if (!token) {
                mostrarResultado("Token no encontrado en la URL.", false);
                return;
            }
            fetch('/api/password/public/reset-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: token, nuevaPassword: nuevaPassword })
            })
            .then(response => {
                if (response.ok) {
                    return response.text();
                } else {
                    return response.text().then(msg => { throw new Error(msg); });
                }
            })
            .then(msg => {
                mostrarResultado("¡Contraseña actualizada correctamente! Ya puedes iniciar sesión.", true);
            })
            .catch(() => {
                mostrarResultado("No se pudo actualizar la contraseña. El enlace es inválido o expiró.", false);
            });
        };
    </script>
</body>
</html>